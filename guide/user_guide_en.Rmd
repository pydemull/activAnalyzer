---
title: |
    | ActivAnalyzer
    | user's guide
author: "Pierre-Yves de Müllenheim"
date: "`r Sys.Date()`"
description: "activAnalyzer"
documentclass: book

output:
  bookdown::pdf_document2:
    includes:
      in_header: preamble.tex
    latex_engine: xelatex

bibliography: references.bib 
biblio-title: References, heading=bibintoc
geometry: "left=4cm, right=3cm, top=2.5cm, bottom=2.5cm"
csl: apa.csl
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
```

# Information
## Assessor
It is possible to provide the name and surname of the assessor. Assessor information must be provided to have a complete document after generating the report at the end of the app.

## Patient
It is possible to provide the name and surname related to the patient, as well as their sex, age, and weight. The user must provide sex, age, and weight information for getting results because these parameters are used to compute basal metabolic rate (BMR) as well as physical activity level (PAL). Patient information must be provided to have a complete document after generating the report at the end of the app.

## Device
It is possible to indicate where the device was placed on the body during the measurement period. Several options are available for the position but for now, the app is designed to work with data recorded at the hip only. Device information must be provided to have a complete document after generating the report at the end of the app. Other relevant information regarding the device (i.e., ActiGraph model, sampling rate, filter enabled when the .agd file was generated from .gt3x data with Actilife® software) are silently captured when uploading the data file.  

# Data uploading, nonwear time detection, and data visualization
The user must upload a .agd file previously generated using Actilife<span>&#174;</span> software. The length of the epoch used in the .agd file (e.g., 10 s, 60 s) has no importance. Once a .agd file is uploaded, behind the scene, the app reads the file and collapses data to get a dataframe with 1-min epochs thanks to R functions provided in the `actigraph.sleepr` R package [@petkovaActigraphSleeprDetect2021]. Then, the app computes the vector magnitude ($VM = \sqrt{x^2 + y^2 + z^2}$). After this step, it is possible to configure the analysis to be performed to detect nonwear time. It consists of choosing the activity data (vector magnitude counts or vertical axis counts) and the time interval to be considered to detect nonwear time, as well as the time interval with nonzero counts allowed during a nonwear period. The default values provided in the app for configuring nonwear time detection are based on the paper by Choi et al. [-@choiAssessmentWearNonwear2012]. Finally, when all inputs are configured as required, the user must click on a "Validate configuration" button. If all inputs are valid, the app detects nonwear time thanks to a function from the `PhysicalActivity` R package [@choiPhysicalActivityProcessAccelerometer2021]. The app then provides a graphic allowing the user to visualize different metrics among those contained in the data file. Completing this step is required before going further in the app.

# Computation of metrics
The user must select an equation to compute METs and the axis and cut-points to be used to compute time spent in sedentary behavior (SED), light physical activity (LPA), moderate physical activity (MPA), vigorous physical activity (VPA), and moderate-to-vigorous physical activity (MVPA). 

The equations provided in the app for computing METs can be retrieved from scientific articles:

* `Sasaki et al. (2011) [Adults]` equation [@sasakiValidationComparisonActiGraph2011].
* `Santos-Lozano et al. (2013) [Adults]` equation [@santos-lozanoActigraphGT3XValidation2013].
* `Freedson et al. (1998) [Adults]` equation [@freedsonCalibrationComputerScience1998].
* `Santos-Lozano et al. (2013) [Older adults]` equation [@santos-lozanoActigraphGT3XValidation2013].

The cut-points provided can also be retrieved from scientific articles:

* Aguilar-Farias et al. [-@aguilar-fariasActiGraphGT3XCutpoints2014] SED cut-points in older adults : <200 counts/min [Vector magnitude];
* Sasaki et al. [-@sasakiValidationComparisonActiGraph2011] MPA and VPA cut-points in adults: $\geqslant$ 2 690 counts/min (MPA) and $\geqslant$ 6 167 counts/min (VPA) [Vector magnitude];
* Santos-Lozano et al. [-@santos-lozanoActigraphGT3XValidation2013] MPA and VPA cut-points in adults: $\geqslant$ 3 208 counts/min (MPA) and $\geqslant$ 8 565 counts/min (VPA) [Vector magnitude];
* Santos-Lozano et al. [-@santos-lozanoActigraphGT3XValidation2013] MPA and VPA cut-points in older adults: $\geqslant$ 2 751 counts/min (MPA) and $\geqslant$ 9 359 counts/min (VPA) [Vector magnitude]. 

These cut-points have been recommended by Migueles et al. [-@miguelesAccelerometerDataCollection2017]. However, in the case where none of them would be satisfactory for the user, the app allows to define personalized cut-points.

Finally, this section allows the user to determine the minimum wear time required to get a valid day. The default value is set to 10 hours (i.e., 600 minutes), as previously recommended [@miguelesAccelerometerDataCollection2017]. Of note, the validation of the whole measurement is left to the appreciation of the user. In the literature, it is commonly accepted to require at least 4 valid days to consider the measurement as a reliable picture of what has been actually performed during a week of measurement. Whatever the number of valid days obtained, keep in mind that one week of measurement may not reflect the average behavior over a year.

Once all inputs are correctly fullfiled, the user must click on the "Run analysis" button. This action triggers several calculations. Firstly, the app computes basal metabolic rate (BMR), based on the sex, age, and weight inputs, and on one of the equations retrieved from the paper by Henry et al. [-@henryBasalMetabolicRate2005]. These equations are shown in Table \@ref(tab:METsEquations).

```{r METsEquations}
library(flextable)
library(officer)
set_flextable_defaults(fonts_ignore = TRUE)
flextable(
tribble(
  ~ "Age category (yr)", ~Sex, ~Equation,
"<3",      "male",   "61.0 * weight - 33.7",
"[3-10[",  "male",   "23.3 * weight + 514",
"[10-18[", "male",   "18.4 * weight + 581",
"[18-30[", "male",   "16.0 * weight + 545",
"[30-60[", "male",   "14.2  * weight + 593",
"[60-70[", "male",   "13.0 * weight + 567",
">=70"   , "male",      "3.7 * weight + 481",

"<3",     "female" , "58.9 * weight - 23.1",
"[3-10[", "female" , "20.1 * weight + 507",
"[10-18[","female", "11.1 * weight + 761",
"[18-30[","female", "13.1 * weight + 558",
"[30-60[","female", "9.74 * weight + 694",
"[60-70[","female", "10.2 * weight +  572",
">=70"   ,"female", "10.0 * weight + 577")
  ) %>%
  theme_zebra() %>%
  align(align = "left", part = "all" ) %>%
  hline_top(part = "all", border = fp_border(width = 1.5)) %>%
  hline_bottom(part = "all", border = fp_border(width = 1.5)) %>%
  width(width = 3)   %>% 
  set_caption("Equations for estimating basal metabolic rate") %>%
  autofit()
```

If the patient considers their sex as "undefined", then an equation for females is used. These equations provides BMR in kcal/day, but the app also silently computes BMR in kcal/min to use it in specific calculations. Then, the following metrics are computed for each 60-s epoch of the dataset:

* METs, by using the MET equation provided by the user;
* Kilocalories, by multiplying the MET value by BMR expressed in kcal/min;
* SED, LPA, MPA, VPA categories based on the axis and the cut-points configured by the user;
* MET-hours related to MPVA, by multipling the MET value by the time (1/60e of an hour), only when the MET value is $\geqslant$ 3.

Once these new metrics added to the initial dataset, the app summarizes the results by day using valid wear time only, this for the following metrics: 

* `wear_time`: total wear time.
* `total_counts_axis1`: total counts for the vertical axis.
* `total_counts_vm`: total counts for the vector magnitude.
* `total_steps`: total step count.
* `total_kcal_wear_time`: total kilocalories.
* `minutes_SED`: total minutes spent in SED behavior.
* `minutes_LPA`: total minutes spent in LPA behavior.
* `minutes_MPA`: total minutes spent in MPA behavior.
* `minutes_VPA`: total minutes spent in VPA behavior.
* `minutes_MVPA`: total minutes spent in MVPA behavior.
* `percent_SED`: proportion of wear time spent in SED behavior.
* `percent_LPA`: proportion of wear time spent in LPA behavior. 
* `percent_MPA`: proportion of wear time spent in MPA behavior.
* `percent_VPA`: proportion of wear time spent in VPA behavior. 
* `percent_MVPA`: proportion of wear time spent in MPVA behavior.
* `mets_hours_mvpa`: total MET-hours spent during MPVA behavior.
* `ratio_mvpa_sed` : ratio between MVPA and SED times (`minutes_MVPA` / `minutes_SED`).


Then, the app computes the PAL for each day. To do this, total energy expenditure (TEE) is divided by BMR. TEE is obtained by summing the kilocalories measured during wear time epochs and the kilocalories likely expended during nonwear time epochs (that is, kilocalories associated to BMR, as it is assumed that the device was mainly not worn during sleeping periods if any, periods during which energy expenditure is near of BMR), and by multiplying this sum by 10/9 to take into account the thermic effect of food. Of course, such calculations may conduct to underestimate TEE and PAL if the device was removed during prolonged periods of physical activity. Moreover, even if the device was correctly worn, the estimate of PAL is very approximate since both BMR and kilocalories related to wear time are estimated using methods that may not be accurate at the individual level.

Finally, the app computes daily averages of the computed metrics using the days considered as valid.


# Results and export
On the app, results by day and those averaged using valid days are shown in tables. The user can click on specific buttons to export either results by day or results averaged using valid days to .csv files. Two last button allows the user to generate a report (in either english or french) where all the inputs of the app are recorded, as well as the results. Some comments are provided at the end of the document to help positioning the patient in relation to normative values or guidelines.


# References
