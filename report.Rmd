---
title: "Results for the measurement of physical behavior"
date: "`r Sys.Date()`"
output: pdf_document
params:
  assessor_title: NA
  assessor_name: NA
  assessor_surname: NA
  patient_title: NA
  patient_name: NA
  patient_surname: NA
  sex: NA
  age: NA
  weight: NA
  start_date: NA
  end_date: NA
  device: NA
  position: NA
  side: NA
  sampling_rate: NA
  filter: NA
  axis_weartime: NA
  frame_size: NA
  allowanceFrame_size: NA
  equation_mets: NA
  bmr_kcal_d: NA
  axis: NA
  sed_cutpoint: NA
  mpa_cutpoint: NA
  vpa_cutpoint: NA
  minimum_wear_time_for_analysis: NA
  results_by_day: NA
  results_summary: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(tidyverse)
library(patchwork)
library(flextable)
library(officer)
```
***
\vspace{2truemm}

# Information

**Assessor**: `r params$assessor_title` `r params$assessor_surname` `r params$assessor_name`

**Patient**: `r params$patient_title` `r params$patient_surname` `r params$patient_name` 

 * Age: `r params$age` yr.
 * Sex: `r params$sex`.
 * Weight: `r params$weight` kg.
 * Measurement period: `r params$start_date` to `r params$end_date`.
 * Estimated Basal Metabolic Rate (BMR): `r format(round(params$bmr_kcal_d, 2), nsmall = 2)` kcal/day*. 

*Estimation based on Henry equations (2005, doi: [10.1079/PHN2005801](https://www.cambridge.org/core/journals/public-health-nutrition/article/basal-metabolic-rate-studies-in-humans-measurement-and-development-of-new-equations/61A9EA486ABFA478FEF2FCE1E70D5BEE)); if the patient reported undefined sex, equations for females were used.

\vspace{3truemm}
**Accelerometer**

 * Device: `r params$device`.
 * Position: `r params$position`.
 * Side: `r params$side`.
 * Sampling rate: `r params$sampling_rate` Hz.
 * Filter: `r params$filter`.

 
**Parameters for accelerometer data analysis**

 * Axis used for analyzing wear time: `r params$axis_weartime`.
 * Size of the interval considered for nonwear time detection: `r params$frame_size` min.
 * Size of the interval allowed during a nonwear epoch: `r params$allowanceFrame_size` min.
 * METs equation: `r params$equation_mets `.
 * Axis used for SED/PA categorization: `r params$axis`.
 * SED cut-point: <`r params$sed_cutpoint` counts/min.
 * MVPA cut-point: >=`r params$mpa_cutpoint` counts/min.
 * Minimum wear time for valid day: `r params$minimum_wear_time_for_analysis` hours.

\vspace{24truemm}
# Summary (Tabular View)

```{r , echo = F, }
df <- params$results_summary

flextable(
 tribble(
    ~Metric,                   ~"Result (daily average)",
    "Wear time (min)",         paste0(round(df[["wear_time"]], 0), " min"),
    "Number of valid days",    paste0(df[["valid_days"]], " day(s)"),
    "PAL",                     paste0(format(round(df[["pal"]], 2), nsmall = 2)),
    "Total number of steps",   paste0(round(df[["total_steps"]], 0), " steps"),
    "SED time",                paste0(format(round(df[["minutes_SED"]], 1), nsmall = 1), " min"),
    "LPA time",                paste0(format(round(df[["minutes_LPA"]], 1), nsmall = 1), " min"),
    "MVPA time",               paste0(format(round(df[["minutes_MVPA"]], 1), nsmall = 1), " min"),
    "SED wear time prop.",         paste0(format(round(df[["percent_SED"]], 1), nsmall = 1), " %"),
    "LPA wear time prop.",         paste0(format(round(df[["percent_LPA"]], 1), nsmall = 1), " %"),
    "MVPA wear time prop.",        paste0(format(round(df[["percent_MVPA"]], 1), nsmall = 1), " %"))
  ) %>%
  theme_zebra() %>%
  align(align = "left", part = "all" ) %>%
  hline_top(part = "all", border = fp_border(width = 1.5)) %>%
  hline_bottom(part = "all", border = fp_border(width = 1.5)) %>%
  width(width = 3)
    
```

```{r, echo = F}
pal_status <- ifelse(df[["pal"]] <1.40, "Insufficient",
                    ifelse(df[["pal"]] <= 1.69, "Sedentary or light activity lifestyle",
                                       ifelse(df[["pal"]] <= 1.99, "Active or moderately active lifestyle",
                                              ifelse(df[["pal"]] <= 2.40, "Vigorous or vigorously active lifestyle", "Likely not sustainable"))))

# ref: http://www.fao.org/3/y5686e/y5686e07.htm#bm07.3
```

# Summary (Graphical View)

```{r, echo = FALSE}
# PAL
table_pal <-
tibble(
  x = c(0, 0.25, 0.5, 0.75, 1),
  label = as.factor(c(
            "Undefined", 
            "Sedentary or light activity lifestyle", 
            "Active or moderately active lifestyle", 
            "Vigorous or vigorously active lifestyle",
            "Difficult to maintain over a long period of time"
            )),
  start = c(1.1, 1.40, 1.70, 2.00, 2.40),
  end = c(1.40, 1.70, 2.00, 2.40, 2.8)
) %>%
  mutate(label = fct_relevel(label,  "Undefined",
                                     "Sedentary or light activity lifestyle", 
                                     "Active or moderately active lifestyle", 
                                     "Vigorous or vigorously active lifestyle",
                                     "Difficult to maintain over a long period of time")) 

library(RColorBrewer)
ggplot(data = table_pal, aes(x = x, y = start)) +
  geom_rect(aes(ymin = start, ymax = end, fill = label), xmin = -Inf, xmax = Inf, alpha = 0.5) +
  geom_vline(aes(xintercept = 0.5,), size = 1, color = "grey30", linetype ="dotted") +
  geom_point(aes(x = 0.5, y = df[["pal"]]), size = 6, color = "red", shape = 1) +
  geom_point(aes(x = 0.5, y = df[["pal"]]), size = 3, color = "red", shape = 16) +
  geom_point(aes(x = 0.5, y = df[["pal"]]), size = 6, color = "red", shape = 3) +
  scale_y_continuous(labels = as.character(format(round(c(1.1, 1.4, 1.7, 2.0, 2.4, 2.8), 2), nsmall = 1)), 
                     breaks = c(1.1, 1.40, 1.70, 2.00, 2.40, 2.80)) +
  scale_fill_brewer(palette="Greens") +
  theme_bw() +
  coord_flip(expand = FALSE) +
  labs(x = "", y = "", fill = "FAO/WHO/UNU categories") +
  theme(axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "right",
        legend.title = element_text(face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  guides(fill=guide_legend(nrow=5)) +
  ggtitle("PAL")


# steps

# MVPA

# SED

```


Based on the determined PAL and the [Food and Agriculture Organization of the United Nations (FAO)](http://www.fao.org/3/y5686e/y5686e.pdf), the activity lifestyle can be qualified as "`r pal_status`".



# Results By Day

```{r, echo = F, out.width='100%'}
# Get dataframe
df <- params$results_by_day

# Set text sizes
title_axis_size = 10
label_text_size = 2
 
# Generate figure
df %>%
  pivot_longer(cols = c(wear_time, total_steps, pal, minutes_SED, minutes_LPA, minutes_MVPA, percent_SED, percent_LPA, percent_MVPA),
               names_to = "variable", values_to = "value") %>%
  mutate(variable = fct_relevel(variable, "wear_time", "total_steps", "pal", 
                                "minutes_SED", "minutes_LPA", "minutes_MVPA", 
                                "percent_SED", "percent_LPA", "percent_MVPA"),
         variable = fct_recode(variable, "Wear time (min)" = "wear_time", "Total steps" = "total_steps", "PAL" = "pal",
                                "SED time (min)" = "minutes_SED", "LPA time (min)" = "minutes_LPA", "MVPA time (min)" = "minutes_MVPA", 
                                "SED wear time prop. (%)" = "percent_SED", "LPA wear time prop. (%)" = "percent_LPA", "MVPA wear time prop. (%)" = "percent_MVPA")) %>%
  ggplot(aes(x = date, y = value)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = round(value, 1), nsmall = 1), size = label_text_size, vjust = -.5) +
  labs(x = "Date", y = "") +
  scale_y_continuous(expand = expansion(mult = c(.05, .2))) +
  theme_bw() + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  facet_wrap(. ~ variable, scales = "free_y")

```


